<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Docente</title>
  <link rel="stylesheet" href="../style/index.css">
</head>
<body>
  <div class="container">
    <h2>Panel de Estudiantes</h2>
    <div id="studentsList" class="cards-container">
      Cargando estudiantes...
    </div>
    <div class="acciones">
      <button class="btn btn-secondary" onclick="exportarResultados()">📄 Exportar Resultados</button>
      <button class="btn btn-danger" onclick="cerrarSesion()">🔒 Cerrar Sesión</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebaseConfig.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const contenedor = document.getElementById('studentsList');
      contenedor.innerHTML = "Cargando estudiantes...";

      try {
        // 🔹 Traer estudiantes desde Firestore
        const snapshot = await db.collection("usuarios")
                                .where("tipo", "==", "student")
                                .get();

        contenedor.innerHTML = "";

        if (snapshot.empty) {
          contenedor.innerHTML = "<p>No hay estudiantes registrados.</p>";
          return;
        }

        snapshot.forEach(doc => {
          const est = doc.data();
          
          // 🔹 Si en Firestore tienes un campo "progreso", úsalo
          const progreso = est.progreso || { correctas: 0, total: 0 };
          const porcentaje = progreso.total > 0 
                             ? Math.round((progreso.correctas / progreso.total) * 100) 
                             : 0;

          // 🔹 Crear tarjeta de estudiante
          const card = document.createElement("div");
          card.className = "card student-card";
          card.innerHTML = `
            <h4>${est.email}</h4>
            <p><strong>Progreso:</strong> ${porcentaje}% (${progreso.correctas}/${progreso.total})</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${porcentaje}%"></div>
            </div>
            <button class="btn btn-secondary" onclick="enviarRecomendacion('${est.email}')">📤 Enviar Recomendación</button>
          `;
          contenedor.appendChild(card);
        });
      } catch (err) {
        contenedor.innerHTML = `<p style="color:red;">❌ Error al cargar estudiantes: ${err.message}</p>`;
      }
    });

    // 🔹 Exportar resultados a CSV (desde Firestore)
    async function exportarResultados() {
      const snapshot = await db.collection("usuarios").where("tipo", "==", "student").get();
      let csv = "Estudiante,Correctas,Totales,Porcentaje\n";

      snapshot.forEach(doc => {
        const est = doc.data();
        const progreso = est.progreso || { correctas: 0, total: 0 };
        const porcentaje = progreso.total > 0 
                           ? Math.round((progreso.correctas / progreso.total) * 100) 
                           : 0;
        csv += `${est.email},${progreso.correctas},${progreso.total},${porcentaje}%\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados.csv";
      a.click();
    }

    // 🔹 Cerrar sesión
    function cerrarSesion() {
      localStorage.removeItem("currentUser");
      auth.signOut().then(() => {
        window.location.href = "../index.html";
      });
    }

    // 🔹 Enviar recomendación (placeholder)
    function enviarRecomendacion(usuario) {
      alert(`📤 Recomendación enviada a ${usuario}`);
    }
  </script>
</body>
</html>
